---
title: "Dimkid analysis"
author: "Kara Weisman"
date: "1/22/2017"
output:
  html_notebook: default
  html_document: default
---

# Preliminaries

## Set up environment

```{r prelim}
library(tidyverse)
library(langcog)
library(stats)
library(psych)
library(GPArotation)
library(lme4)
library(RColorBrewer)

# clear environment
rm(list=ls())
graphics.off()
```

## Read in data

```{r reading}
# ADULT run 01 (3-point scale)
d_adult01 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/adults/us_run-01_2016-06-05_anonymized.csv") %>% select(-X)

# # ADULT run 02 (7-point scale)
# d_adult02 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/adults/us_run-02_2016-07-19_anonymized.csv") %>% select(-X)
# 
# # ADULT run 03 (3-point scale, original wording for 'free will' and 'intentions')
# d_adult03 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/adults/us_run-03_2016-12-08_anonymized.csv") %>% select(-X)

# CHILD run 01 [lydia, olivia, allie (summer 2016) + nicky, dru, ariel, olivia (fall 2016) + campbell (winter 2017)]
d_child01 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/children/run-01_2017-01-19_anonymized.csv") %>% select(-X)

# demographic info (for children)
child_demo <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/children/dimkid_participant_ages_2017-01-19.csv")
```

## Tidy data

```{r tidying}
# tidy adult run 01
d_adult02 <- d_adult01 %>%
  select(subid, age, gender, ethnicity, duration,
         charName, trialNum, capacity, capWording, 
         hoverTime, rt, response, responseNum) %>%
  rename(character = charName,
         sessionDuration = duration) %>%
  mutate(ageGroup = "adult")

# tidy demographics
child_demo_tidy <- child_demo %>%
  mutate(subid = gsub(" ", "", subid)) %>%
  mutate(subid = gsub("-", "", subid)) %>%
  mutate(subid = toupper(subid)) %>%
  select(subid, age, gender, ethnicity)

# tidy child run 01
d_child02 <- d_child01 %>%
  filter(character %in% c("beetle", "robot"))  %>% # no elephant condition! (n = 1 child)
  select(subid, sessionDuration,
         character, trialNum, capacity, capWording, 
         hoverTime, rt, response, responseNum) %>%
  mutate(ageGroup = "child") %>%
  mutate(subid = gsub(" ", "", subid)) %>%
  mutate(subid = gsub("-", "", subid)) %>%
  mutate(subid = toupper(subid)) %>%
  left_join(child_demo_tidy) %>%
  mutate(subid = factor(as.character(subid)))

# combine datasets
d <- d_adult02 %>%
  full_join(d_child02) %>%
  mutate(subid = factor(subid),
         character = factor(character),
         capWording = factor(gsub("\\ ", "_", gsub(" --.*", "", capWording))),
         responseCat = factor(response, levels = c("no", "kinda", "yes")),
         responseNum = ifelse(response == "no", 0,
                              ifelse(response == "kinda", 0.5,
                                     ifelse(response == "yes", 1,
                                            NA))),
         ageGroup = factor(ageGroup, levels = c("adult", "child"))) %>%
  distinct()
```
# Demographics

```{r n participants}
# total n
d %>% 
  select(ageGroup, subid, age) %>%
  distinct(.keep_all = T) %>%
  mutate(ageGroup2 = ifelse(ageGroup == "adult",
                            "adult",
                            ifelse(age < 7 | age > 10, 
                                   "out of age range",
                                   ifelse(is.na(age), 
                                          "missing age",
                                          "child")))) %>%
  count(ageGroup2)

# drop children outside of target age range (7-9y)
d1 <- d %>%
  filter((age >= 7 & age <= 10) | ageGroup == "adult")

d1 %>% 
  select(ageGroup, subid, age) %>%
  distinct(.keep_all = T) %>%
    mutate(ageGroup2 = ifelse(ageGroup == "adult",
                            "adult",
                            ifelse(age < 7 | age > 10, 
                                   "out of age range",
                                   ifelse(is.na(age), 
                                          "missing age",
                                          "child")))) %>%
  count(ageGroup2)
```

```{r condition}
# condition
d1 %>% 
  select(ageGroup, subid, character) %>%
  distinct(.keep_all = T) %>%
  count(ageGroup, character)
```

```{r age}
# age 
d1 %>% 
  select(ageGroup, subid, age) %>%
  distinct(.keep_all = T) %>%
  group_by(ageGroup) %>%
  summarise(mean_age = mean(age, na.rm = T),
            sd_age = sd(age, na.rm = T),
            median_age = median(age, na.rm = T),
            min_age = min(age, na.rm = T),
            max_age = max(age, na.rm = T))

# plot children's age
qplot(d1 %>% 
        filter(ageGroup == "child") %>%
        distinct(subid, .keep_all = T) %>% 
        select(age), bins = 18) +
  geom_vline(xintercept = median(d1$age[d1$ageGroup == "child"], na.rm = T), color = "red")

# check children's age by condition
d1 %>% 
  filter(ageGroup == "child") %>%
  distinct(subid, .keep_all = T) %>% 
  select(age, character) %>%
  group_by(character) %>% 
  summarise(median = median(age, na.rm = T))

t.test(age ~ character, 
       d1 %>% 
         filter(ageGroup == "child") %>%
         select(subid, age, character) %>% 
         distinct)

ggplot(d1 %>%
         filter(ageGroup == "child") %>%
         distinct(subid, .keep_all = T) %>% 
         select(age, character) %>%
         group_by(character) %>%
         mutate(median_age = median(age, na.rm = T)),
       aes(x = age)) +
  geom_histogram(bins = 9) +
  facet_wrap(~ character) +
  geom_vline(xintercept = median(d$age[d$ageGroup == "child"], na.rm = T), color = "black") +
  geom_vline(aes(xintercept = median_age, color = character), lty = 2)
```

```{r duration}
# duration
d1 %>%
  group_by(ageGroup) %>%
  summarise(mean = mean(sessionDuration, na.rm = T),
            median = median(sessionDuration, na.rm = T),
            min = min(sessionDuration, na.rm = T),
            max = max(sessionDuration, na.rm = T))

# plot duration by age group and character
ggplot(d1, aes(sessionDuration)) +
  facet_grid(character ~ ageGroup) +
  geom_histogram(breaks = 0:15)

t.test(sessionDuration ~ character,
       d1 %>%
         filter(ageGroup == "child") %>%
         select(subid, character, sessionDuration) %>%
         left_join(d %>% select(subid, sessionDuration)) %>%
         mutate(subid = as.character(subid),
                character = factor(character),
                sessionDuration = round(as.numeric(as.character(sessionDuration)), 3)) %>%
         distinct())

t.test(sessionDuration ~ character,
       d1 %>%
         filter(ageGroup == "adult") %>%
         select(subid, character, sessionDuration) %>%
         left_join(d %>% select(subid, sessionDuration)) %>%
         mutate(subid = as.character(subid),
                character = factor(character),
                sessionDuration = round(as.numeric(as.character(sessionDuration)), 3)) %>%
         distinct())
```

```{r gender}
# gender
d1 %>%
  select(ageGroup, subid, gender) %>%
  distinct(.keep_all = T) %>%
  count(ageGroup, gender)
```

```{r ethnicity}
# ethnicity
d1 %>% 
  select(ageGroup, subid, ethnicity) %>%
  mutate(ethnicity = tolower(ethnicity)) %>%
  mutate(black = grepl("black", ethnicity) |
           grepl("african american", ethnicity),
         east_asian = grepl("east asian", ethnicity) |
           grepl("eastasian", ethnicity) |
           grepl("chinese", ethnicity) |
           grepl("china", ethnicity) |
           grepl("korea", ethnicity) |
           grepl("japan", ethnicity) |
           grepl("taiwan", ethnicity),
         south_asian = grepl("south asian", ethnicity) |
           grepl("southasian", ethnicity) |
           grepl("india", ethnicity) |
           grepl("pakistan", ethnicity) |
           grepl("bangla", ethnicity) |
           grepl("sri lanka", ethnicity),
         latino = grepl("latin", ethnicity) |
           grepl("hispanic", ethnicity) |
           grepl("mexic", ethnicity),
         middle_eastern = grepl("middle", ethnicity),
         pac_island = grepl("pacific", ethnicity) |
           grepl("hawaii", ethnicity),
         native_am = grepl("nativeamerican", ethnicity) |
           grepl("native american", ethnicity) |
           grepl("american indian", ethnicity) |
           grepl("alaska native", ethnicity),
         white = grepl("white", ethnicity),
         other = grepl("other", ethnicity)) %>%
  distinct(.keep_all = T) %>%
  gather(ethnicityTF, TF, -subid, -ethnicity, -ageGroup) %>%
  filter(TF) %>%
  count(ageGroup, ethnicityTF)

# NOTE: not mutually exclusive!!

# mutually exclusive version
d1 %>% 
  select(ageGroup, subid, ethnicity) %>%
  mutate(ethnicity = tolower(ethnicity)) %>%
  distinct(.keep_all = T) %>%
  mutate(ethnicity2 = ifelse(ageGroup == "adult",
                             ifelse(grepl(",", ethnicity), "multiple", ethnicity),
                             ifelse(grepl(";", ethnicity), "multiple", ethnicity))) %>% 
  mutate(ethnicity3 = ifelse(grepl("other", ethnicity2),
                             ifelse(grepl("/", ethnicity2) | grepl("mix", ethnicity2),
                                    "multiple",
                                    ifelse(grepl("asian", ethnicity2) | grepl("korean", ethnicity2),
                                           "east asian",
                                           ethnicity2)),
                             ethnicity2)) %>%
  count(ageGroup, ethnicity3) %>%
  ungroup() %>%
  group_by(ageGroup) %>%
  mutate(prop = n/sum(n)) %>%
  arrange(ageGroup, desc(n))
```

```{r missing data}
# experimineter error
d_child01 %>% # use d_child01 (before dropping n = 1 child in "elephant" condition)
  filter(!(character %in% c("beetle", "robot"))) %>%
  select(subid) %>%
  distinct() %>%
  count() %>%
  mutate(percent = n/200)

# incomplete trials ("skip", "bail")
d1 %>% # use d1 (before dropping trials with rt > 250ms) 
  count(ageGroup, subid) %>%
  filter(n != 40) %>%
  mutate(n_missing = 40-n) %>%
  group_by(ageGroup) %>%
  summarise(sum_missing = sum(n_missing)) %>%
  mutate(percent = sum_missing/8000)

# trials with rt > 250ms
d1 %>%
  filter(rt < 250) %>%
  count(ageGroup) %>%
  mutate(percent = n/8000)

# all missing trials
d1 %>% # use d1 (before dropping trials) 
  count(ageGroup, subid) %>%
  filter(n != 40) %>%
  mutate(n_NA = 40-n) %>%
  group_by(ageGroup) %>%
  summarise(n_NA = sum(n_NA)) %>%
  mutate(percent_NA = n_NA/8000) %>%
  full_join(d1 %>%
              filter(rt < 250) %>%
              count(ageGroup) %>%
              rename(n_fast = n) %>%
              mutate(percent_fast = n_fast/8000)) %>%
  mutate(n_missing_TOTAL = n_NA + n_fast,
         percent_missing_TOTAL = percent_NA + percent_fast)
  
```

# Data preparation

## Filter RTs

```{r filter RTs, prep dataframe}
# examine and filter by RTs
ggplot(d1) +
  geom_histogram(aes(x = rt), bins = 100) +
  facet_wrap(~ageGroup) +
  scale_x_log10(breaks = seq(0, 1000, 100)) +
  geom_vline(xintercept = 250, color = "red")

d2 <- d1 %>%
  filter(!(rt < 250) | is.na(rt)) # preset criterion of 250ms
```

## Look at hover time

```{r hover time}
d2 %>%
  filter(!(capacity %in% c("personality", "beliefs", "pleasure", "desires", "self_restraint", "goals", "nauseated"))) %>%
  mutate(noHover = hoverTime == 0) %>%
  count(ageGroup, noHover) %>%
  group_by(ageGroup) %>%
  mutate(percent = n/sum(n))

ggplot(d2, aes(x = hoverTime)) +
  facet_grid(~ ageGroup) +
  geom_histogram()
```

## Prepare data for EFA

```{r prep for efa}
# finish tidying
d3 <- d2 %>%
  select(capacity, responseNum, subid) %>%
  spread(capacity, responseNum)

# make combined dataset
d3_combined <- data.frame(d3[,-1], row.names = d3[,1])

# make separate child and adult datasets
d3_adult <- d3 %>%
  left_join(d %>% select(subid, ageGroup)) %>%
  filter(ageGroup == "adult") %>%
  select(-ageGroup) %>%
  distinct()
d3_adult <- data.frame(d3_adult[,-1], row.names = d3_adult[,1])

d3_child <- d3 %>%
  left_join(d %>% select(subid, ageGroup)) %>%
  filter(ageGroup == "child") %>%
  select(-ageGroup) %>%
  distinct()
d3_child <- data.frame(d3_child[,-1], row.names = d3_child[,1])
```

## General analysis settings

```{r analysis settings}
# set correlation type: pearson or polychoric?
cor_type <- "cor"
# cor_type <- "poly"

# set rotation type: varimax or oblimin?
rot_type <- "varimax"
# rot_type <- "oblimin"

# set score type
# score_type <- "regression"
# score_type <- "Thurstone"
score_type <- "tenBerge"
# score_type <- "Anderson"
# score_type <- "Bartlett"
# score_type <- "Harman"
```

# Adults alone

## Exploratory factor analysis

### Maximal (13-factor) unrotated solution

```{r efa adults maximal unrotated}
# do factor analysis
efa_adult_max_unrot <- fa(d3_adult, nfactors = 13, rotate = "none", cor = cor_type)
efa_adult_max_unrot

# examine eigenvalues and variance explained
efa_adult_max_unrot_eigenvalues <- print(efa_adult_max_unrot)$Vaccounted %>%
  t() %>%
  data.frame()

# count factors with eigenvalues > 1 and variance explained > 5%
efa_adult_max_unrot_nfactors <- efa_adult_max_unrot_eigenvalues %>%
  filter(SS.loadings > 1, Proportion.Explained > 0.05) %>%
  count() %>%
  as.numeric()
efa_adult_max_unrot_nfactors

# manually check that each factor is the dominant factor for at least one mental capacity item
efa_adult_max_unrot_loadings <- fa.sort(loadings(efa_adult_max_unrot)[]) %>%
  data.frame() %>%
  select(1:efa_adult_max_unrot_nfactors) %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3, F4 = MR4) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         F4_abs = abs(F4),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs, F4_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        ifelse(loading_abs == abs(F4), F4,
                                               NA)))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       ifelse(loading == F4, "F4",
                                              NA)))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           ifelse(loading == F4, "Factor 4",
                                                  NA)))))

efa_adult_max_unrot_loadings %>% count(factorName) # drop any factors where n < 1

# reset as needed
efa_adult_max_unrot_nfactors <- efa_adult_max_unrot_loadings %>% count(factorName) %>% nrow()
```

### Maximal (13-factor) rotated solution

```{r efa adults maximal rotated}
# do factor analysis
efa_adult_max_rot <- fa(d3_adult, nfactors = 13, rotate = rot_type, cor = cor_type)
efa_adult_max_rot

# examine eigenvalues and variance explained
efa_adult_max_rot_eigenvalues <- print(efa_adult_max_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_adult_max_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

### Small rotated solution

```{r efa adults small rotated}
# do factor analysis
efa_adult_small_rot <- fa(d3_adult, nfactors = efa_adult_max_unrot_nfactors, rotate = rot_type, cor = cor_type)
efa_adult_small_rot

# examine eigenvalues and variance explained
efa_adult_small_rot_eigenvalues <- print(efa_adult_small_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_adult_small_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

#### Loadings

```{r efa adults small rotated loadings}
# make dataframe for all factor loadings and dominant factor
efa_adult_small_rot_loadings <- efa_adult_small_rot$loadings[] %>%
  fa.sort() %>%
  data.frame() %>%
  rownames_to_column(var = "capacity") %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        NA))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       NA))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           NA)))) %>%
  select(capacity, F1, F2, F3, factor, factorName, loading, loading_abs) %>%
  distinct() %>%
  full_join(d %>% select(capacity, capWording)) %>%
  mutate(capWording = gsub("\\ ", "_", gsub(" --.*", "", capWording))) %>%
  select(capacity, capWording, F1:loading_abs) %>%
  distinct()

# print out list of items by dominant factor
efa_adult_small_rot_items <- efa_adult_small_rot_loadings %>%
  arrange(factor, desc(loading_abs)) %>%
  mutate(capWordingPlus = ifelse(loading > 0, capWording, 
                                 paste0(capWording, " (negative loading)"))) %>%
  group_by(factor) %>%
  summarise(items = gsub("_", " ", paste(capWordingPlus, collapse = ", ")))
head(efa_adult_small_rot_items$items, 40)
```

# Children alone

## Exploratory factor analysis

### Maximal (13-factor) unrotated solution

```{r efa children maximal unrotated}
# do factor analysis
efa_child_max_unrot <- fa(d3_child, nfactors = 13, rotate = "none", cor = cor_type)
efa_child_max_unrot

# examine eigenvalues and variance explained
efa_child_max_unrot_eigenvalues <- print(efa_child_max_unrot)$Vaccounted %>%
  t() %>%
  data.frame()

# count factors with eigenvalues > 1 and variance explained > 5%
efa_child_max_unrot_nfactors <- efa_child_max_unrot_eigenvalues %>%
  filter(SS.loadings > 1, Proportion.Explained > 0.05) %>%
  count() %>%
  as.numeric()
efa_child_max_unrot_nfactors

# manually check that each factor is the dominant factor for at least one mental capacity item
efa_child_max_unrot_loadings <- fa.sort(loadings(efa_child_max_unrot)[]) %>%
  data.frame() %>%
  select(1:efa_child_max_unrot_nfactors) %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        NA))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       NA))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           NA))))

efa_child_max_unrot_loadings %>% count(factorName) # drop any factors where n < 1

# reset as needed
efa_child_max_unrot_nfactors <- efa_child_max_unrot_loadings %>% count(factorName) %>% nrow()
```

### Maximal (13-factor) rotated solution

```{r efa children maximal rotated}
# do factor analysis
efa_child_max_rot <- fa(d3_child, nfactors = 13, rotate = rot_type, cor = cor_type)
efa_child_max_rot

# examine eigenvalues and variance explained
efa_child_max_rot_eigenvalues <- print(efa_child_max_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_child_max_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

### Small rotated solution

```{r efa children small rotated}
# do factor analysis
efa_child_small_rot <- fa(d3_child, nfactors = efa_child_max_unrot_nfactors, rotate = rot_type, cor = cor_type)
efa_child_small_rot

# examine eigenvalues and variance explained
efa_child_small_rot_eigenvalues <- print(efa_child_small_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_child_small_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

#### Loadings

```{r efa children small rotated loadings}
# make dataframe for all factor loadings and dominant factor
efa_child_small_rot_loadings <- efa_child_small_rot$loadings[] %>%
  fa.sort() %>%
  data.frame() %>%
  rownames_to_column(var = "capacity") %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        NA))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       NA))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           NA)))) %>%
  select(capacity, F1, F2, F3, factor, factorName, loading, loading_abs) %>%
  distinct() %>%
  full_join(d %>% select(capacity, capWording)) %>%
  mutate(capWording = gsub("\\ ", "_", gsub(" --.*", "", capWording))) %>%
  select(capacity, capWording, F1:loading_abs) %>%
  distinct()

# print out list of items by dominant factor
efa_child_small_rot_items <- efa_child_small_rot_loadings %>%
  arrange(factor, desc(loading_abs)) %>%
  mutate(capWordingPlus = ifelse(loading > 0, capWording, 
                                 paste0(capWording, " (negative loading)"))) %>%
  group_by(factor) %>%
  summarise(items = gsub("_", " ", paste(capWordingPlus, collapse = ", ")))
head(efa_child_small_rot_items$items, 40)
```

# Combined dataset: Children & adults

## Exploratory factor analysis

### Maximal (13-factor) unrotated solution

```{r efa combined maximal unrotated}
# do factor analysis
efa_comb_max_unrot <- fa(d3_combined, nfactors = 13, rotate = "none", cor = cor_type)
efa_comb_max_unrot

# examine eigenvalues and variance explained
efa_comb_max_unrot_eigenvalues <- print(efa_comb_max_unrot)$Vaccounted %>%
  t() %>%
  data.frame()

# count factors with eigenvalues > 1 and variance explained > 5%
efa_comb_max_unrot_nfactors <- efa_comb_max_unrot_eigenvalues %>%
  filter(SS.loadings > 1, Proportion.Explained > 0.05) %>%
  count() %>%
  as.numeric()
efa_comb_max_unrot_nfactors

# manually check that each factor is the dominant factor for at least one mental capacity item
efa_comb_max_unrot_loadings <- fa.sort(loadings(efa_comb_max_unrot)[]) %>%
  data.frame() %>%
  select(1:efa_comb_max_unrot_nfactors) %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        NA))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       NA))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           NA))))

efa_comb_max_unrot_loadings %>% count(factorName) # drop any factors where n < 1
```

### Maximal (13-factor) rotated solution

```{r efa combined maximal rotated}
# do factor analysis
efa_comb_max_rot <- fa(d3_combined, nfactors = 13, rotate = rot_type, cor = cor_type)
efa_comb_max_rot

# examine eigenvalues and variance explained
efa_comb_max_rot_eigenvalues <- print(efa_comb_max_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_comb_max_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

### Small rotated solution

```{r efa combined small rotated}
# do factor analysis
efa_comb_small_rot <- fa(d3_combined, nfactors = efa_comb_max_unrot_nfactors, rotate = rot_type, cor = cor_type)
efa_comb_small_rot

# examine eigenvalues and variance explained
efa_comb_small_rot_eigenvalues <- print(efa_comb_small_rot)$Vaccounted %>%
  t() %>%
  data.frame()
efa_comb_small_rot_eigenvalues

# but see https://www.researchgate.net/post/How_to_calculate_the_explained_variance_per_factor_in_a_principal_axis_factor_analysis if rotation != "varimax"
# takeaway: use "Proportion.Var" instead of "Proportion.Explained"
```

#### Loadings

```{r efa combined small rotated loadings}
# make dataframe for all factor loadings and dominant factor
efa_comb_small_rot_loadings <- efa_comb_small_rot$loadings[] %>%
  fa.sort() %>%
  data.frame() %>%
  rownames_to_column(var = "capacity") %>%
  rename(F1 = MR1, F2 = MR2, F3 = MR3) %>% # adjust by hand as needed
  mutate(F1_abs = abs(F1),
         F2_abs = abs(F2),
         F3_abs = abs(F3),
         loading_abs = pmax(F1_abs, F2_abs, F3_abs),
         loading = ifelse(loading_abs == abs(F1), F1,
                          ifelse(loading_abs == abs(F2), F2,
                                 ifelse(loading_abs == abs(F3), F3,
                                        NA))),
         factor = ifelse(loading == F1, "F1",
                         ifelse(loading == F2, "F2",
                                ifelse(loading == F3, "F3",
                                       NA))),
         factorName = ifelse(loading == F1, "Factor 1",
                             ifelse(loading == F2, "Factor 2",
                                    ifelse(loading == F3, "Factor 3",
                                           NA)))) %>%
  select(capacity, F1, F2, F3, factor, factorName, loading, loading_abs) %>%
  distinct() %>%
  full_join(d %>% select(capacity, capWording)) %>%
  mutate(capWording = gsub("\\ ", "_", gsub(" --.*", "", capWording))) %>%
  select(capacity, capWording, F1:loading_abs) %>%
  distinct()

# print out list of items by dominant factor
efa_comb_small_rot_items <- efa_comb_small_rot_loadings %>%
  arrange(factor, desc(loading_abs)) %>%
  mutate(capWordingPlus = ifelse(loading > 0, capWording, 
                                 paste0(capWording, " (negative loading)"))) %>%
  group_by(factor) %>%
  summarise(items = gsub("_", " ", paste(capWordingPlus, collapse = ", ")))
head(efa_comb_small_rot_items$items, 40)
```

# Regression on factor scores

## Children vs. adults

```{r regression age group data prep}
scores_all <- fa(d3_combined, nfactors = efa_comb_max_unrot_nfactors, rotate = rot_type,
                 cor = cor_type, scores = score_type)$scores %>%
  data.frame() %>%
  rownames_to_column(var = "subid") %>%
  mutate(ageGroup = factor(ifelse(grepl("run", subid), "adult", "child")))

colnames(scores_all)[2:4] <- c("score_F1", "score_F2", "score_F3")
```

```{r regression age group analysis}
# analyze
scores_all_analysis <- d %>%
  select(subid, ageGroup, character) %>%
  distinct() %>%
  left_join(scores_all) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1) & !is.na(score_F2) & !is.na(score_F3), !is.na(ageGroup)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor))

# set contrasts
contrasts(scores_all_analysis$factor) <- cbind(F1 = c(1, -1, 0), # MAKE SURE TO DOUBLE-CHECK!!
                                               F3 = c(0, -1, 1))
contrasts(scores_all_analysis$character) <- cbind(robot = c(-1, 1))
contrasts(scores_all_analysis$ageGroup) <- cbind(child = c(-1, 1))

r1 <- lmer(score ~ character * factor + (1 | subid), scores_all_analysis)
r2 <- lmer(score ~ character * factor + ageGroup + (1 | subid), scores_all_analysis)
r3 <- lmer(score ~ character * factor * ageGroup + (1 | subid), scores_all_analysis)
anova(r1, r2, r3)
# summary(r1)
# summary(r2)
summary(r3)

round(signif(summary(r3)$coefficients, 3), 2) %>% data.frame() # %>% View()

# stepwise regression
drop1(r3, test = "Chisq")
r3_step2 <- lmer(score ~ character * factor + ageGroup + character:ageGroup + factor:ageGroup + (1 | subid), scores_all_analysis)
drop1(r3_step2, test = "Chisq")
r3_step3 <- lmer(score ~ character * factor + ageGroup + factor:ageGroup + (1 | subid), scores_all_analysis)
drop1(r3_step3, test = "Chisq")

# # robot only
# robot_r1 <- lmer(score ~ factor + (1 | subid), scores_all_analysis %>% filter(character == "robot"))
# robot_r2 <- lmer(score ~ factor + ageGroup + (1 | subid), scores_all_analysis %>% filter(character == "robot"))
# robot_r3 <- lmer(score ~ factor * ageGroup + (1 | subid), scores_all_analysis %>% filter(character == "robot"))
# anova(robot_r1, robot_r2, robot_r3)
# # summary(robot_r1)
# # summary(robot_r2)
# summary(robot_r3)
```

```{r regression age group plot}
scores_all_plotting <- d %>%
  select(subid, ageGroup, character) %>%
  distinct() %>%
  full_join(scores_all) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1), !is.na(score_F2), !is.na(score_F3), !is.na(ageGroup)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor)) %>%
  multi_boot(column = "score",
             summary_groups = c("ageGroup", "character", "factor"),
             statistics_functions = c("mean", "ci_lower", "ci_upper"))

# plot
ggplot(scores_all_plotting %>%
         ungroup() %>%
         mutate(factor = factor(factor,
                                labels = c("Social-emotional",
                                           "Physiological",
                                           "Perceptual-cognitive")),
                ageGroup = factor(ageGroup,
                                  levels = c("child", "adult"),
                                  labels = c("children", "adults"))),
       aes(x = ageGroup, y = mean, color = character, shape = character)) +
  facet_wrap("factor", ncol = 3) +
  theme_bw() +
  theme(text = element_text(size = 28),
        legend.position = "bottom") +
  geom_point(size = 5, position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), 
                width = 0.2, position = position_dodge(width = 0.4)) +
  scale_shape_manual(values = c(19, 15)) +
  labs(title = "Factor scores by age group",
       # subtitle = "Adults (Study 1) vs. children (Study 2)\n",
       x = "Age group",
       y = "Mean factor score") # 1000 by 500
```

## Children by age at test

```{r regression age at test data prep}
scores_children <- fa(d3_child, nfactors = efa_comb_max_unrot_nfactors, rotate = rot_type,
                 cor = cor_type, scores = score_type)$scores %>%
  data.frame() %>%
  rownames_to_column(var = "subid") %>%
  mutate(ageGroup = factor(ifelse(grepl("run", subid), "adult", "child")))

colnames(scores_children)[2:4] <- c("score_F1", "score_F2", "score_F3")
```

```{r regression age at test analysis}
# analyze
scores_children_analysis <- d %>%
  select(subid, age, character) %>%
  distinct() %>%
  left_join(scores_children) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1) & !is.na(score_F2) & !is.na(score_F3), !is.na(ageGroup)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor))

# set contrasts
contrasts(scores_children_analysis$factor) <- cbind(F1 = c(1, -1, 0), # MAKE SURE TO DOUBLE-CHECK!!
                                               F3 = c(0, -1, 1))
contrasts(scores_children_analysis$character) <- cbind(robot = c(-1, 1))

r4 <- lmer(score ~ character * factor + (1 | subid), scores_children_analysis)
r5 <- lmer(score ~ character * factor + scale(age) + (1 | subid), scores_children_analysis)
r6 <- lmer(score ~ character * factor * scale(age) + (1 | subid), scores_children_analysis)
anova(r4, r5, r6)
# summary(r4)
# summary(r5)
summary(r6)

# stepwise regression
drop1(r6, test = "Chisq")
r6_step2 <- lmer(score ~ character * factor + scale(age) + character:scale(age) + factor:scale(age) + (1 | subid), scores_children_analysis)
drop1(r6_step2, test = "Chisq")
summary(r6_step2)

# explore polynoial effects of age
r6b <- lmer(score ~ character * factor * poly(age, 1) + (1 | subid), scores_children_analysis)
r7 <- lmer(score ~ character * factor * poly(age, 2) + (1 | subid), scores_children_analysis)
r8 <- lmer(score ~ character * factor * poly(age, 3) + (1 | subid), scores_children_analysis)
anova(r6b, r7, r8)
# summary(r6b)
# summary(r7)
summary(r8)

round(signif(summary(r6)$coefficients, 3), 2) %>% data.frame() # %>% View()

# stepwise regression
drop1(r8, test = "Chisq")
r8_step2 <- lmer(score ~ character * factor * poly(age, 2) + poly(age, 3) + poly(age, 3):character + poly(age, 3):factor + (1 | subid), scores_children_analysis)
drop1(r8_step2, test = "Chisq")
r8_step3 <- lmer(score ~ character * factor + poly(age, 3) + (1 | subid) + poly(age, 2) + character:poly(age, 2) + factor:poly(age, 2), scores_children_analysis)
drop1(r8_step3, test = "Chisq")
summary(r8_step3)

# # robot only
# robot_r4 <- lmer(score ~ factor + (1 | subid), scores_children_analysis %>% filter(character == "robot"))
# robot_r5 <- lmer(score ~ factor + scale(age) + (1 | subid), scores_children_analysis %>% filter(character == "robot"))
# robot_r6 <- lmer(score ~ factor * scale(age) + (1 | subid), scores_children_analysis %>% filter(character == "robot"))
# anova(robot_r4, robot_r5, robot_r6)
# # summary(robot_r4)
# # summary(robot_r5)
# summary(robot_r6)
```

```{r regression age at test plot}
scores_children_plotting <- d %>%
  select(subid, age, character) %>%
  distinct() %>%
  full_join(scores_children) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1), !is.na(score_F2), !is.na(score_F3), !is.na(age)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor)) %>%
  multi_boot(column = "score",
             summary_groups = c("age", "character", "factor"),
             statistics_functions = c("mean", "ci_lower", "ci_upper"))

# plot
ggplot(scores_children_plotting %>%
         ungroup() %>%
         mutate(factor = factor(factor,
                                labels = c("Social-emotional",
                                           "Physiological",
                                           "Perceptual-cognitive"))),
       aes(x = age, y = mean, color = character, fill = character, shape = character)) +
  facet_wrap("factor", ncol = 3) +
  theme_bw() +
  theme(text = element_text(size = 28),
        legend.position = "bottom") +
  # geom_smooth(method = "loess", alpha = 0.4) +
  geom_smooth(method = "lm", alpha = 0.4) +
  geom_point(size = 2) +
  scale_shape_manual(values = c(19, 15)) +
  labs(title = "Factor scores by children's age",
       # subtitle = "Children (Study 2)\n",
       x = "Age (years)",
       y = "Factor score") # 1000 by 500
```

## Adults by age at test

```{r regression adult age at test data prep}
scores_adults <- fa(d3_adult, nfactors = efa_comb_max_unrot_nfactors, rotate = rot_type,
                 cor = cor_type, scores = score_type)$scores %>%
  data.frame() %>%
  rownames_to_column(var = "subid") %>%
  mutate(ageGroup = factor(ifelse(grepl("run", subid), "adult", "adult")))

colnames(scores_adults)[2:4] <- c("score_F1", "score_F2", "score_F3")
```

```{r regression adult age at test analysis}
# analyze
scores_adults_analysis <- d %>%
  select(subid, age, character) %>%
  distinct() %>%
  left_join(scores_adults) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1) & !is.na(score_F2) & !is.na(score_F3), !is.na(age)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor))

# set contrasts
contrasts(scores_adults_analysis$factor) <- cbind(F1 = c(1, -1, 0), # MAKE SURE TO DOUBLE-CHECK!!
                                               F3 = c(0, -1, 1))
contrasts(scores_adults_analysis$character) <- cbind(robot = c(-1, 1))

r4 <- lmer(score ~ character * factor + (1 | subid), scores_adults_analysis)
r5 <- lmer(score ~ character * factor + scale(age) + (1 | subid), scores_adults_analysis)
r6 <- lmer(score ~ character * factor * scale(age) + (1 | subid), scores_adults_analysis)
anova(r4, r5, r6)
# summary(r4)
# summary(r5)
summary(r6)

# stepwise regression
drop1(r6, test = "Chisq")
r6_step2 <- lmer(score ~ character * factor + scale(age) + character:scale(age) + factor:scale(age) + (1 | subid), scores_adults_analysis)
drop1(r6_step2, test = "Chisq")
summary(r6_step2)

# explore polynoial effects of age
r6b <- lmer(score ~ character * factor * poly(age, 1) + (1 | subid), scores_adults_analysis)
r7 <- lmer(score ~ character * factor * poly(age, 2) + (1 | subid), scores_adults_analysis)
r8 <- lmer(score ~ character * factor * poly(age, 3) + (1 | subid), scores_adults_analysis)
anova(r6b, r7, r8)
# summary(r6b)
summary(r7)
summary(r8)

round(signif(summary(r6)$coefficients, 3), 2) %>% data.frame() # %>% View()

# stepwise regression
drop1(r8, test = "Chisq")
r8_step2 <- lmer(score ~ character * factor * poly(age, 2) + poly(age, 3) + poly(age, 3):character + poly(age, 3):factor + (1 | subid), scores_adults_analysis)
drop1(r8_step2, test = "Chisq")
r8_step3 <- lmer(score ~ character * factor + poly(age, 3) + (1 | subid) + poly(age, 2) + character:poly(age, 2) + factor:poly(age, 2), scores_adults_analysis)
drop1(r8_step3, test = "Chisq")
summary(r8_step3)
```

```{r regression adult age at test plot}
scores_adults_plotting <- d %>%
  filter(!is.na(age)) %>%
  select(subid, age, character) %>%
  distinct() %>%
  full_join(scores_adults) %>%
  mutate(character = factor(character)) %>%
  filter(!is.na(score_F1), !is.na(score_F2), !is.na(score_F3), !is.na(age)) %>%
  gather(factor, score, starts_with("score_")) %>%
  mutate(factor = factor(factor)) %>%
  multi_boot(column = "score",
             summary_groups = c("age", "character", "factor"),
             statistics_functions = c("mean", "ci_lower", "ci_upper"))

# plot
ggplot(scores_adults_plotting %>%
         ungroup() %>%
         mutate(factor = factor(factor,
                                labels = c("Social-emotional",
                                           "Physiological",
                                           "Perceptual-cognitive"))),
       aes(x = age, y = mean, color = character, fill = character, shape = character)) +
  facet_wrap("factor", ncol = 3) +
  theme_bw() +
  theme(text = element_text(size = 28),
        legend.position = "bottom") +
  # geom_smooth(method = "loess", alpha = 0.4) +
  geom_smooth(method = "lm", alpha = 0.4) +
  geom_point(size = 2) +
  scale_shape_manual(values = c(19, 15)) +
  labs(title = "Factor scores by adults's age",
       # subtitle = "Adults (Study 2)\n",
       x = "Age (years)",
       y = "Factor score") # 1000 by 500
```

## Big figure

```{r big figure}
# by condition
d1_bycond2 <- d2 %>%
  left_join(d_child02 %>% select(subid, age)) %>%
  select(character, capacity, capWording, responseNum, subid, ageGroup, age) %>%
  filter(capacity != "na", is.na(responseNum) == F) %>%
  mutate(capWording = gsub(" --.*", "", capWording),
         ageGroup3 = ifelse(ageGroup == "adult", "adult",
                            ifelse(is.na(age), NA,
                                   ifelse(age < 8, "7y", 
                                          ifelse(age < 9, "8y",
                                                 ifelse(age < 10, "9y",
                                                        NA)))))) %>%
  distinct()

d1_bycond2 %>% select(ageGroup3, subid) %>% distinct() %>% count(ageGroup3)

# make df for plotting
d1_bycond2_mb <- multi_boot(d1_bycond2,
                           column = "responseNum",
                           summary_groups = c("ageGroup3", "character", "capacity", "capWording"),
                           statistics_functions = c("mean", "ci_lower", "ci_upper"))

d1_bycond2_mb_factorsAll <- d1_bycond2_mb %>% 
  full_join(efa_comb_small_rot_loadings %>%
              group_by(factor) %>%
              mutate(order = rank(desc(loading_abs)))) %>%
  arrange(character, factor, desc(loading_abs)) %>%
  rownames_to_column(var = "full_order") %>%
  mutate(full_order = as.numeric(full_order)) %>%
  arrange(factorName, full_order) %>%
  ungroup() %>%
  filter(!is.na(ageGroup3)) %>%
  mutate(factorName = factor(factorName,
                             levels = c("Factor 1", "Factor 2", "Factor 3"),
                             labels = c("Social-emotional", 
                                        "Physiological", 
                                        "Perceptual-cognitive")))

dodge_width <- 2

ggplot(d1_bycond2_mb_factorsAll, 
       aes(x = desc(order*2), y = mean,
           color = ageGroup3, shape = ageGroup3,
           label = capWording)) +
  facet_grid(factorName ~ character, scales = "free", space = "free") +
  geom_hline(yintercept = 0, lty = 3) +
  geom_hline(yintercept = 0.5, lty = 3) +
  geom_hline(yintercept = 1, lty = 3) +
  geom_point(stat = "identity", position = position_dodge(width = dodge_width), size = 8) +
  scale_shape_manual(values = c(rep(18, 3), 17)) +
  # scale_colour_brewer(type = "seq", palette = "PuRd") +
  scale_colour_hue(h = c(0, 180)) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                position = position_dodge(width = dodge_width), width = 0) +
  geom_text(aes(y = -0.5, hjust = 0), 
            color = "black",
            # color = d1_bycond2_mb_factorsAll$textColor,
            size = 8) +
  labs(title = "Responses by mental capacity item",
       y = "Mean response (0 = NO, 0.5 = KINDA, 1 = YES)",
       x = "Capacity",
       color = "Age group: ", shape = "Age group: ") +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 28),
        # axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top") # 1700 by 2000

```

```{r tables and chisq tests for items}
# FILTERED BY ROBOT

# feel safe
with(d2 %>% filter(capWording == "feel_safe", 
                   !is.na(responseCat),
                   character == "robot"),
     table(ageGroup, responseCat)) #%>%
  #summary()

# feel tired
with(d2 %>% filter(capWording == "feel_tired", 
                   !is.na(responseCat),
                   character == "robot"),
     table(ageGroup, responseCat)) #%>%
  #summary()

# feel scared
with(d2 %>% filter(capWording == "feel_scared", 
                   !is.na(responseCat),
                   character == "robot"),
     table(ageGroup, responseCat)) #%>%
  #summary()

# get hungry
with(d2 %>% filter(capWording == "get_hungry", 
                   !is.na(responseCat),
                   character == "robot"),
     table(ageGroup, responseCat)) #%>%
  #summary()

# feel pain
with(d2 %>% filter(capWording == "feel_pain", 
                   !is.na(responseCat),
                   character == "robot"),
     table(ageGroup, responseCat)) #%>%
  #summary()

# feel proud
proud_table <- with(d2 %>% filter(capWording == "feel_proud", 
                   !is.na(responseCat),
                   character == "robot") %>%
       mutate(ageGroup3 = ifelse(ageGroup == "adult", "adult",
                                 ifelse(is.na(age), NA,
                                        ifelse(age < 8, "7",
                                               ifelse(age < 9, "8",
                                                      "9"))))),
     table(ageGroup3, responseCat)) %>%
  prop.table(1) 
proud_table
proud_table[3,2]+proud_table[3,3]

# feel happy
happy_table <- with(d2 %>% filter(capWording == "feel_happy", 
                   !is.na(responseCat),
                   character == "robot") %>%
       mutate(ageGroup3 = ifelse(ageGroup == "adult", "adult",
                                 ifelse(is.na(age), NA,
                                        ifelse(age < 8, "7",
                                               ifelse(age < 9, "8",
                                                      "9"))))),
     table(ageGroup3, responseCat)) %>%
  prop.table(1) 
happy_table
happy_table[3,2]+happy_table[3,3]

# feel guilty
guilty_table <- with(d2 %>% filter(capWording == "feel_guilty", 
                   !is.na(responseCat),
                   character == "robot") %>%
       mutate(ageGroup3 = ifelse(ageGroup == "adult", "adult",
                                 ifelse(is.na(age), NA,
                                        ifelse(age < 8, "7",
                                               ifelse(age < 9, "8",
                                                      "9"))))),
     table(ageGroup3, responseCat)) %>%
  prop.table(1) 
guilty_table
guilty_table[1,2]+guilty_table[1,3]
guilty_table[2,2]+guilty_table[2,3]
guilty_table[3,2]+guilty_table[3,3]

clm_guilty <- ordinal::clm(responseCat ~ age,
                           data = d2 %>% 
                             filter(capWording == "feel_guilty",
                                    !is.na(responseCat),
                                    character == "robot"))
summary(clm_guilty)

# personality
personality_table <- with(d2 %>% filter(capWording == "have_a_personality", 
                   !is.na(responseCat),
                   character == "robot") %>%
       mutate(ageGroup3 = ifelse(ageGroup == "adult", "adult",
                                 ifelse(is.na(age), NA,
                                        ifelse(age < 8, "7",
                                               ifelse(age < 9, "8",
                                                      "9"))))),
     table(ageGroup3, responseCat)) %>%
  prop.table(1) 
personality_table
personality_table[3,2]+personality_table[3,3]

# self-control
self_control_table <- with(d2 %>% filter(capWording == "have_self-control", 
                   !is.na(responseCat),
                   character == "robot") %>%
       mutate(ageGroup3 = ifelse(ageGroup == "adult", "adult",
                                 ifelse(is.na(age), NA,
                                        ifelse(age < 8, "7",
                                               ifelse(age < 9, "8",
                                                      "9"))))),
     table(ageGroup3, responseCat)) %>%
  prop.table(1) 
self_control_table
self_control_table[1,2]+self_control_table[1,3]
self_control_table[2,2]+self_control_table[2,3]
self_control_table[3,2]+self_control_table[3,3]

clm_self_control <- ordinal::clm(responseCat ~ age,
                                 data = d2 %>% 
                                   filter(capWording == "have_self-control",
                                          !is.na(responseCat),
                                          character == "robot"))
summary(clm_self_control)

# MORE GENERAL

at_least_kinda_9y <- d2 %>% 
  filter(!is.na(responseCat),
         ageGroup == "child",
         !is.na(age),
         age > 9) %>%
  distinct() %>%
  count(character, capacity, responseCat) %>%
  group_by(character, capacity) %>%
  mutate(prop_n = n/sum(n, na.rm = T)) %>%
  select(-n) %>%
  spread(responseCat, prop_n) %>% # n) %>%
  mutate(at_least_kinda = sum(kinda, yes)) %>%
  left_join(efa_comb_small_rot_loadings) %>%
  arrange(factor, desc(at_least_kinda))

at_least_kinda_9y %>%
  select(character:at_least_kinda, factor, loading)

at_least_kinda_adult <- d2 %>% 
  filter(!is.na(responseCat),
         character == "robot",
         ageGroup == "adult") %>%
  distinct() %>%
  count(capacity, responseCat) %>%
  group_by(capacity) %>%
  mutate(prop_n = n/sum(n, na.rm = T)) %>%
  select(-n) %>%
  spread(responseCat, prop_n) %>% # n) %>%
  mutate(at_least_kinda = sum(kinda, yes)) %>%
  left_join(efa_comb_small_rot_loadings) %>%
  arrange(factor, desc(at_least_kinda))

at_least_kinda_adult %>%
  select(capacity:at_least_kinda, factor, loading)

```

## BIG TABLE

```{r big table}
# make dataframe
big_table <- efa_adult_small_rot_loadings %>% 
  setNames(paste0('adult_', names(.))) %>% 
  rename(capacity = adult_capacity, 
         capWording = adult_capWording) %>%
  full_join(efa_child_small_rot_loadings %>%
              setNames(paste0('child_', names(.))) %>%
              rename(capacity = child_capacity,
                     capWording = child_capWording)) %>%
  full_join(efa_comb_small_rot_loadings %>%
              setNames(paste0('comb_', names(.))) %>%
              rename(capacity = comb_capacity, 
                     capWording = comb_capWording)) %>%
  arrange(comb_factor, desc(comb_loading_abs)) %>%
  mutate(capWording = gsub("_", " ", capWording)) %>%
  select(capWording, 
         adult_F2, child_F1, comb_F1, # double-check adults!
         adult_F1, child_F2, comb_F2, # double-check adults!
         adult_F3, child_F3, comb_F3) %>%
  column_to_rownames(var = "capWording") %>%
  signif(3) %>%
  round(2)

big_table
```

```{r relationships between scores}
cor.plot(scores_all %>% column_to_rownames(var = "subid") %>% select(-ageGroup))
cor.test(scores_all$score_F1, scores_all$score_F2, use = "complete.obs")
cor.test(scores_all$score_F1, scores_all$score_F3, use = "complete.obs")
cor.test(scores_all$score_F2, scores_all$score_F3, use = "complete.obs")


cor.ci(scores_adults %>% column_to_rownames(var = "subid") %>% select(-ageGroup))
cor.ci(scores_children %>% column_to_rownames(var = "subid") %>% select(-ageGroup))
cor.ci(scores_all %>% column_to_rownames(var = "subid") %>% select(-ageGroup))
```

```{r new plot}
# by condition
d1_bycond3 <- d2 %>%
  left_join(d_child02 %>% select(subid, age)) %>%
  select(character, capacity, capWording, responseCat, subid, ageGroup, age) %>%
  filter(capacity != "na", !is.na(responseCat)) %>%
  mutate(capWording = gsub(" --.*", "", capWording),
         ageGroup3 = ifelse(ageGroup == "adult", "adult",
                            ifelse(is.na(age), NA,
                                   ifelse(age < 8, "7y", 
                                          ifelse(age < 9, "8y",
                                                 ifelse(age < 10, "9y",
                                                        NA)))))) %>%
  distinct()

d1_bycond3 %>% select(ageGroup3, subid) %>% distinct() %>% count(ageGroup3)

# make df for plotting
d1_bycond3_mb_factorsAll <- d1_bycond3 %>% 
  full_join(efa_comb_small_rot_loadings %>%
              group_by(factor) %>%
              mutate(order = rank(desc(loading_abs)))) %>%
  arrange(character, factor, desc(loading_abs)) %>%
  rownames_to_column(var = "full_order") %>%
  mutate(full_order = as.numeric(full_order)) %>%
  arrange(factorName, full_order) %>%
  ungroup() %>%
  filter(!is.na(ageGroup3)) %>%
  mutate(factorName = factor(factorName,
                             levels = c("Factor 1", "Factor 2", "Factor 3"),
                             labels = c("Social-emotional", 
                                        "Physiological", 
                                        "Perceptual-cognitive")),
         agentic = ifelse(capWording %in% c("decide_what_to_do", "make_choices", "have_self_control", 
                                            "make_plans", "have_goals", 
                                            "understand_how_somebody_else_is_feeling",
                                            "know_what's_nice_and_what's_mean", "have_thoughts",
                                            "remember_things", "communicate_with_somebody_else"),
                          TRUE, FALSE))


d1_bycond3_annotate <- d1_bycond3_mb_factorsAll %>% 
  filter(order <= 4) %>% 
  select(character, order, capWording) %>% 
  distinct()

# ggplot(d1_bycond3_mb_factorsAll %>% filter(order <= 4), 
#        aes(x = interaction(ageGroup3, desc(order*2)), 
#            # y = responseCat,
#            # color = ageGroup3, shape = ageGroup3,
#            fill = responseCat,
#            label = ageGroup3)) +
#            # label = gsub("_", " ", paste(capWording, ageGroup3, sep = ": ")))) +
#   # facet_grid(factorName ~ character * order, scales = "free", space = "free") +
#   facet_grid(factorName ~ character, scales = "free", space = "free") +
#   geom_bar(position = "fill") +
#   geom_text(aes(y = -0.5, hjust = 0), 
#             color = "black",
#             # color = d1_bycond2_mb_factorsAll$textColor,
#             size = 8) +
#   geom_text(aes(x = order, y = 1.5, label = capWording), hjust = -1) +
#   # annotate("text", aes(facet = order, label = d1_bycond3_annotate$capWording)) +
#   labs(title = "Responses by mental capacity item",
#        y = "Relative frequency",
#        x = "Capacity * Age group",
#        fill = "Response: ") +
#   scale_y_continuous(breaks = c(0, 0.5, 1)) +
#   # coord_flip() +
#   theme_bw() +
#   theme(text = element_text(size = 28),
#         # axis.title.y = element_blank(),
#         axis.text.y = element_blank(),
#         axis.ticks.y = element_blank(),
#         legend.position = "top") # 1700 by 2000

ggplot(d1_bycond3_mb_factorsAll %>% 
         filter(order <= 5) %>%
         mutate(facet = tools::toTitleCase(paste0(character, " (", ageGroup, ")"))), 
         # mutate(facet = tools::toTitleCase(paste(ageGroup, character, sep = ": "))), 
       aes(x = desc(order*2), 
           fill = character,
           alpha = responseCat,
           # fill = responseCat,
           label = gsub("_", " ", capWording))) +
  facet_grid(factorName ~ facet) + #, scales = "free", space = "free") +
  geom_bar(position = "stack", color = "black") +
  scale_alpha_manual(values=c(0.4, 0.7, 1)) +
  geom_text(aes(y = 5, hjust = 0), 
            color = "black",
            # color = d1_bycond2_mb_factorsAll$textColor,
            size = 8) +
  labs(title = "Responses by mental capacity item",
       y = "Count",
       x = "Capacity",
       alpha = "Response: ",
       fill = "Character: ") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 28),
        # axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top") # 2000 by 1200

ggplot(d1_bycond3_mb_factorsAll %>%
         # filter(order <= 10) %>%
         # filter(order <= 5 | capWording %in% c("know_what's_nice_and_what's_mean",
         #                                       "make_choices")) %>% # add selected agency by factor
         mutate(facet = tools::toTitleCase(paste0(character, " (", ageGroup, ")"))), 
         # mutate(facet = tools::toTitleCase(paste(ageGroup, character, sep = ": "))), 
       aes(x = desc(order*2), 
           fill = character,
           alpha = responseCat,
           # fill = responseCat,
           label = gsub("_", " ", capWording))) +
  facet_grid(factorName ~ facet, scales = "free", space = "free") +
  geom_bar(position = "stack", color = "black") +
  scale_alpha_manual(values=c(0.4, 0.7, 1)) +
  geom_text(aes(y = 5, hjust = 0), 
            color = "black",
            # color = d1_bycond2_mb_factorsAll$textColor,
            size = 8) +
  labs(title = "Responses by mental capacity item",
       y = "Count",
       x = "Capacity",
       alpha = "Response: ",
       fill = "Character: ") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 32),
        # axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top") # 2000 by 1200

```

```{r srcd plot version 1}
d_srcd <- d1_bycond3_mb_factorsAll %>% 
         filter(factor == "F1", order <= 5) %>%
  select(ageGroup, character, responseCat, order, capWording) %>%
  mutate(labeller = ifelse(responseCat == "no", gsub("_", " ", capWording), NA)) %>%
  distinct()
  
ggplot(d1_bycond3_mb_factorsAll %>% 
         filter(factor == "F1", order <= 5) %>%
         mutate(facet = tools::toTitleCase(paste(ageGroup, character, sep = ": "))),
       aes(x = desc(order*2), 
           fill = character,
           alpha = responseCat,
           label = gsub("_", " ", capWording))) +
  facet_grid(factorName ~ facet) + #, scales = "free", space = "free") +
  geom_bar(position = "stack", color = "black") +
  scale_alpha_manual(values=c(0.2, 0.5, 1)) +
  # scale_alpha_manual(values=c(0.4, 0.7, 1)) +
  geom_text(data = d_srcd, 
            aes(x = desc(order*2), label = labeller, y = 5),
            hjust = 0, angle = 90, color = "black", size = 8, alpha = 1) +
  labs(title = "Responses by mental capacity item",
       y = "Count",
       x = "Capacity",
       alpha = "Response: ",
       fill = "Character: ") +
  theme_bw() +
  theme(text = element_text(size = 28),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") # 1000 by 500
```

```{r srcd plot version 2}
d_srcd2 <- d1_bycond3_mb_factorsAll %>% 
         filter(factor == "F1", order <= 5, character == "robot") %>%
  select(ageGroup, character, responseCat, order, capWording) %>%
  mutate(labeller = ifelse(responseCat == "no", gsub("_", " ", capWording), NA)) %>%
  distinct()
  
ggplot(d1_bycond3_mb_factorsAll %>% 
         filter(factor == "F1", order <= 5) %>%
         mutate(facet = tolower(paste(ageGroup, character, sep = ": "))) %>%
         mutate(facet = factor(facet, 
                               levels = c("child: beetle", "child: robot", 
                                          "adult: beetle", "adult: robot"),
                               labels = c("children: beetle", "children: robot", 
                                          "adults: beetle", "adults: robot"))) %>%
         mutate(ageGroup2 = factor(ageGroup, levels = c("child", "adult"),
                                   labels = c("children", "adults"))),
       aes(x = desc(order*2), 
           fill = character,
           alpha = responseCat,
           label = gsub("_", " ", capWording))) +
  facet_grid(~ facet) + #, scales = "free", space = "free") +
  geom_bar(position = "stack", color = "black") +
  scale_alpha_manual(values=c(0.2, 0.5, 1)) +
  # scale_alpha_manual(values=c(0.4, 0.7, 1)) +
  geom_text(data = d_srcd2, 
            aes(x = desc(order*2), label = labeller, y = 5),
            hjust = 0, angle = 90, color = "black", size = 8, alpha = 1) +
  labs(y = "Count",
       x = "Capacity",
       alpha = "Response: ",
       fill = "Character: ") +
  labs(title = "Responses (raw counts)",
       y = "Count",
       x = "Capacity",
       alpha = "response: ",
       fill = "character: ") +
  theme_bw() +
  theme(text = element_text(size = 28),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") # 1000 by 500

ggplot(d1_bycond3_mb_factorsAll %>% 
         filter(factor == "F1", order <= 5, character == "robot") %>%
         mutate(facet = tools::toTitleCase(paste(ageGroup, character, sep = ": "))) %>%
         mutate(facet = factor(facet, 
                               levels = c("Child: Robot", "Adult: Robot"),
                               labels = c("Children: robot", "Adults: robot"))) %>%
         mutate(ageGroup2 = factor(ageGroup, levels = c("child", "adult"),
                                   labels = c("children", "adults"))),
       aes(x = desc(order*2), 
           alpha = responseCat,
           label = gsub("_", " ", capWording))) +
  facet_grid(~ ageGroup2) + #, scales = "free", space = "free") +
  geom_bar(position = "stack", color = "black", fill = "#00BFC4") +
  scale_alpha_manual(values=c(0.2, 0.5, 1)) +
  # scale_alpha_manual(values=c(0.4, 0.7, 1)) +
  geom_text(data = d_srcd2, 
            aes(x = desc(order*2), label = labeller, y = 5),
            hjust = 0, angle = 90, color = "black", size = 8, alpha = 1) +
  labs(y = "Count",
       x = "Capacity",
       alpha = "Response: ",
       fill = "Character: ") +
  theme_bw() +
  theme(text = element_text(size = 28),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom") # 600 by 500
```