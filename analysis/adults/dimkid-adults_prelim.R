library(dplyr)
library(tidyr)
library(stats)
library(psych)
library(ggplot2)
library(tibble)

# adults
d <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Dimkid/dimkid/data/adults/us_run-01_2016-06-05_anonymized.csv")          

# plot log(rts)
qplot(d$rt, bins = 100) + 
  scale_x_log10(breaks = seq(0, 1000, 100)) +
  geom_vline(xintercept = 250, color = "red")

d0 <- d %>%
  filter(rt >= 250)

d1 <- d0 %>%
  select(capWording, responseNum, subid) %>%
  spread(capWording, responseNum)

d2 <- data.frame(d1[,-1], row.names = d1[,1])

cor3 <- cor(d2, method = "spearman", use = "complete.obs")

m <- as.matrix(d2)
heatmap(m)

cluster <- hclust(dist(t(m)))
plot(cluster)


VSS.scree(cor3)
fa(cor3, nfactors = 13, rotate = "none")
# fa(cor3, nfactors = 4, rotate = "none")
# fa(cor3, nfactors = 3, rotate = "none")
fa(cor3, nfactors = 13, rotate = "varimax")
# fa(cor3, nfactors = 4, rotate = "varimax")
# fa(cor3, nfactors = 3, rotate = "varimax")
fa.sort(fa(cor3, nfactors = 4, rotate = "varimax")$loadings[]) %>% View()
fa.sort(fa(cor3, nfactors = 3, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3, nfactors = 2, rotate = "varimax")$loadings[]) %>% View()

fa.sort(fa(cor3, nfactors = 3, rotate = "varimax")$loadings[]) %>% round(2) %>% data.frame() %>% rownames_to_column() %>% View()

fa.sort(fa(cor3, nfactors = 4, rotate = "varimax")$loadings[]) %>% round(2) %>% data.frame() %>% rownames_to_column() %>% View()

fa.sort(fa(cor3, nfactors = 7, rotate = "varimax")$loadings[]) %>% round(2) %>% data.frame() %>% rownames_to_column() %>% View()


# loadings <- fa(cor3, nfactors = 3, rotate = "varimax")$loadings[] %>% data.frame() %>% rownames_to_column() %>% mutate(rowname = factor(rowname)) %>% arrange(rowname)
# capacities <- data.frame(rowname = levels(d$capWording)) %>% arrange(rowname)
# 
# full_join(loadings, capacities) %>% View() 

plot(fa(cor3, nfactors = 4, rotate = "varimax"))




#### EXPLORATORY

# remove items with mandatory definitions
d3a <- d2[!grepl("\\.\\.\\.", names(d2))]

cor3a <- cor(d3a, method = "spearman", use = "complete.obs")

VSS.scree(cor3a)
fa(cor3a, nfactors = 13, rotate = "none")
# fa(cor3a, nfactors = 4, rotate = "none")
# fa(cor3a, nfactors = 3, rotate = "none")
fa(cor3a, nfactors = 13, rotate = "varimax")
# fa(cor3a, nfactors = 4, rotate = "varimax")
# fa(cor3a, nfactors = 3, rotate = "varimax")
fa.sort(fa(cor3a, nfactors = 5, rotate = "varimax")$loadings[]) %>% View()
fa.sort(fa(cor3a, nfactors = 4, rotate = "varimax")$loadings[]) %>% View()
fa.sort(fa(cor3a, nfactors = 3, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3a, nfactors = 2, rotate = "varimax")$loadings[]) %>% View()


# remove "cognitive" agency items
d3b <- d2 %>%
  select (-decide.what.to.do, -figure.out.how.to.do.things, -have.self.control....like.when.you.stop.yourself.from.doing.something.you.shouldn.t.do)

cor3b <- cor(d3b, method = "spearman", use = "complete.obs")

VSS.scree(cor3b)
fa(cor3b, nfactors = 13, rotate = "none")
# fa(cor3b, nfactors = 4, rotate = "none")
# fa(cor3b, nfactors = 3, rotate = "none")
fa(cor3b, nfactors = 13, rotate = "varimax")
# fa(cor3b, nfactors = 4, rotate = "varimax")
# fa(cor3b, nfactors = 3, rotate = "varimax")
# fa.sort(fa(cor3b, nfactors = 5, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3b, nfactors = 4, rotate = "varimax")$loadings[]) %>% View()
fa.sort(fa(cor3b, nfactors = 3, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3b, nfactors = 2, rotate = "varimax")$loadings[]) %>% View()

# remove (a priori) "substnantially reworded" agency items
d3c <- d2 %>%
  select (-do.math, -be.aware.of.things, -feel.sad, -sense.whether.something.is.close.by.or.far.away, -get.hurt.feelings, -feel.scared, -decide.what.to.do, -make.plans, -know.what.s.nice.and.what.s.mean, -feel.sick....like.when.you.feel.like.you.might.throw.up, -smell.things, -figure.out.how.to.do.things, -be.aware.of.itself, -have.self.control....like.when.you.stop.yourself.from.doing.something.you.shouldn.t.do, -hear.sounds)

cor3c <- cor(d3c, method = "spearman", use = "complete.obs")

VSS.scree(cor3c)
fa(cor3c, nfactors = 13, rotate = "none")
# fa(cor3c, nfactors = 4, rotate = "none")
# fa(cor3c, nfactors = 3, rotate = "none")
fa(cor3c, nfactors = 13, rotate = "varimax")
# fa(cor3c, nfactors = 4, rotate = "varimax")
# fa(cor3c, nfactors = 3, rotate = "varimax")
# fa.sort(fa(cor3c, nfactors = 5, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3c, nfactors = 4, rotate = "varimax")$loadings[]) %>% View()
fa.sort(fa(cor3c, nfactors = 3, rotate = "varimax")$loadings[]) %>% View()
# fa.sort(fa(cor3c, nfactors = 2, rotate = "varimax")$loadings[]) %>% View()


